<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order Form</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="styles.css">
</head>
<body class="bg-light">
    <div class="loader-overlay show">
        <img src="https://paperless-form.github.io/inventory-managment/loading.svg">
    </div>
    <div class="container py-5">
        <div class="row justify-content-center">
            <div class="col-12">
                <!-- Header Section -->
                <div class="text-center mb-5">
                    <h1 class="display-5 fw-bold text-primary mb-3">Place Your Order</h1>
                    <p class="lead text-muted">Complete your customer and product details below</p>
                </div>

                <form id="formValues" action="https://script.google.com/macros/s/AKfycbwrlgN60-n1LiPXw7baYUVMCTIIEe836UAqC3WUZLHR56Gl21pKKKoiWcWXTGdLbzzE5Q/exec" method="POST">
                    <!-- Customer Details Card -->
                    <div class="card shadow-lg border-0 rounded-4 mb-4">
                        <div class="card-header bg-primary bg-gradient text-white border-0 rounded-top-4 py-3">
                            <h4 class="mb-0 fw-bold">
                                <i class="bi bi-person-circle me-2"></i>
                                Customer Details
                            </h4>
                        </div>
                        <div class="card-body p-4">
                            <div class="row g-3">
                                <!-- Customer Name -->
                                <div class="col-12 col-md-6">
                                    <label for="customerName" class="form-label fw-semibold">Student ID or full name if unknown <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control form-control-lg required" id="customerName" placeholder="Enter your full name" name="customer_name">
                                    <input type="hidden" name="page" value="order_form">
                                    <input type="hidden" name="date">
                                    <input type="hidden" name="order_ref">
                                </div>

                                <!-- Email Address -->
                                <div class="col-12 col-md-6">
                                    <label for="emailAddress" class="form-label fw-semibold">Email Address <span class="text-danger">*</span></label>
                                    <input type="email" class="form-control form-control-lg required email" id="emailAddress" placeholder="Enter your email address" name="email_address">
                                </div>

                                <!-- Phone Number -->
                                <div class="col-12 col-md-6">
                                    <label for="phoneNumber" class="form-label fw-semibold">Phone Number <span class="text-danger">*</span></label>
                                    <input type="tel" class="form-control form-control-lg number required" id="phoneNumber" placeholder="Enter your phone number" name="phone_number">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Product Details Card -->
                    <div class="card shadow-lg border-0 rounded-4 mb-4">
                        <div class="card-header bg-success bg-gradient text-white border-0 rounded-top-4 py-3">
                            <h4 class="mb-0 fw-bold">
                                <i class="bi bi-cart-check me-2"></i>
                                Product Details
                            </h4>
                        </div>
                        <div class="card-body p-4">
                                                        <!-- Product Table -->
                            <div class="table-responsive">
                                <table class="table table-hover product-table">
                                    <thead class="table-light">
                                        <tr>
                                            <th scope="col" class="fw-semibold" width="30%">Category</th>
                                            <th scope="col" class="fw-semibold" width="30%">Product</th>
                                            <!-- <th scope="col" class="fw-semibold" width="15%">Unit / Weight</th> -->
                                            <th scope="col" class="fw-semibold" width="18%">In Stock</th>
                                            <th scope="col" class="fw-semibold" width="17%">Quantity</th>
                                            <th scope="col" class="fw-semibold text-center" width="5%">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="productTableBody">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Order Summary Card -->
                    <div class="card shadow-lg border-0 rounded-4 mb-4">
                        <div class="card-header bg-info bg-gradient text-white border-0 rounded-top-4 py-3">
                            <h4 class="mb-0 fw-bold">
                                <i class="bi bi-calculator me-2"></i>
                                Order Summary
                            </h4>
                        </div>
                        <div class="card-body p-4">
                            <div class="row g-3">
                                <div class="col-12">
                                    <div class="d-flex justify-content-between align-items-center p-3 bg-light rounded-3">
                                        <span class="fw-semibold">Total Items:</span>
                                        <span class="fw-bold text-success fs-5 total-items">0</span>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <label for="notes" class="form-label fw-semibold">Notes</label>
                                    <textarea class="form-control form-control-lg" id="notes" rows="4" placeholder="Add any additional notes or descriptions..." name="notes"></textarea>
                                </div>
        
                                <!-- Buttons -->
                                <div class="col-12">
                                    <button type="button" class="btn btn-primary py-3" id="save-btn">
                                        Submit
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>

                <!-- Footer Info -->
                <div class="text-center mt-4">
                    <p class="text-muted small">
                        <i class="bi bi-shield-check me-1"></i>
                        Your order information is secure and encrypted
                    </p>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <script>
        var stock = '', product_options = '', category_options = '', categories = [];
        $(document).ready(function(){
            var date = new Date();
            var today =addZero(date.getDate())+ '/' + addZero(date.getMonth() + 1) + '/' +date.getFullYear() ;
            $('input[name="date"]').val(today);
            $('input[name="order_ref"]').val(addZero(date.getHours())+ '' + addZero(date.getMinutes()) + '' + addZero(date.getSeconds())+ '' + addZero(date.getDate())+ '' + addZero(date.getMonth() + 1) + '' +date.getFullYear());

            $.get('https://script.google.com/macros/s/AKfycbwrlgN60-n1LiPXw7baYUVMCTIIEe836UAqC3WUZLHR56Gl21pKKKoiWcWXTGdLbzzE5Q/exec?page=order-form',function(response){
                stock = response.stock;
                
                for(var i=0; i<stock.length; i++){
                    if(stock[i][4] != '' && stock[i][4] != "0" && categories.indexOf(stock[i][0]) == -1){
                        category_options += `<option value="${stock[i][0]}">${stock[i][0]}</option>`;
                        categories.push(stock[i][0]);
                    }
                }
                addProductRow();
                $('.loader-overlay').hide();
            });
        });

        function addZero(i) {
            if (i < 10) {
                i = "0" + i;
            }
            return i;
        }
        // <td>
        //                 <div>
        //                     <input type="text" class="form-control unit-weight" readonly placeholder="Unit Weight" name="unit_weight">
        //                 </div>
        //             </td>
        function addProductRow(){
            $('.btn-outline-success').addClass('btn-outline-danger').removeClass('btn-outline-success');
            $('.add-product').addClass('delete-product').removeClass('add-product');
            $('.bi-plus').addClass('bi-trash').removeClass('bi-plus');
            $('#productTableBody').append(`
                <tr class="product-row">
                    <td>
                        <div>
                            <select class="form-select category-select select2 required" name="category">
                                <option value="" selected disabled>Select Category</option>
                                ${category_options}
                            </select>
                        </div>
                    </td>
                    <td>
                        <div>
                            <select class="form-select product-select select2 required" name="product">
                                <option value="" selected disabled>Select Product</option>
                            </select>
                        </div>
                    </td>
                    
                    <td>
                        <div>
                            <input type="text" class="form-control in-stock" readonly placeholder="In Stock">
                        </div>
                    </td>
                    <td>
                        <div>
                            <input type="text" class="form-control quantity-input required number" placeholder="Qty" name="quantity">
                        </div>
                    </td>
                    <td class="text-center"><button type="button" class="btn btn-outline-success add-product text-center fw-bold"><i class="bi bi-plus"></i></button></td>
                </tr>
            `);
            
            $(".select2.select2-hidden-accessible").select2('destroy');
            $('.select2').select2({
                width: '100%',
                tags: true
            });
        }

        $(document).on('change', '.category-select', function(){
            var value = $(this).find('option:selected').val();
            var tr = $(this).closest('tr');
            tr.find('.product-select').empty();
            tr.find('.product-select').append(`<option value="" selected disabled>Select Product</option>`);
            
            // tr.find('.unit-weight').val('');
            tr.find('.in-stock').val('');

            for(var i=0; i<stock.length; i++){
                if(stock[i][0] == value && stock[i][4] != '' && stock[i][4] != "0"){
                    tr.find('.product-select').append(`<option value="${stock[i][1]}" data-id="${i}">${stock[i][1]}</option>`);
                }
            }
        })

        $(document).on('change', '.product-select', function(){
            var value = $(this).find('option:selected').val();
            var tr = $(this).closest('tr');
            var category = tr.find('.category-select').find('option:selected').val();
            var id = $(this).find('option:selected').data('id');
            var count = 0
            if(category != '' && value != '' && id != undefined){
                $('tr').each(function(){
                    if($(this).find('.category-select').val() == category && $(this).find('.product-select').val() == value ) 
                    {
                        count = count*1 + 1
                    }
                })

                if(count == 2)
                {
                    // tr.find('.unit-weight').val('');
                    tr.find('.in-stock').val('');
                    tr.find('.quantity-input').val('');
                    Swal.fire({
                        title: "Error",
                        text: "Product Already Selected",
                        icon: "error",
                    })
                    tr.find('.product-select option[value=""]').prop('selected', true).trigger('change');
                }
                else{
                    $('.total-items').text($('.quantity-input').length*1);
                    // tr.find('.unit-weight').val(stock[id][2]);
                    tr.find('.in-stock').val(stock[id][4]);
                }
            }
            else{
                // tr.find('.unit-weight').val('');
                tr.find('.in-stock').val('');
                tr.find('.quantity-input').val('');
                $('.total-items').text($('.quantity-input').length*1);
            }
        })

        $(document).on('input', '.quantity-input', function(){
            var value = $(this).val()
            var stock = $(this).closest('tr').find('.in-stock').val()
            if($(this).val() != "")
            {
                if(value*1 > stock*1)
                {
                    $(this).val(stock);
                }
            }
        })

        $(document).on('click', '.add-product', function(){
            addProductRow();
        })

        $(document).on('click', '.delete-product', function(){
            $(this).closest('tr').remove();
            $('.total-items').text($('.quantity-input').length*1);
        })

        function validate() {
            var valid = true;
            $('input, select, .select2-selection').removeClass('danger')
            $(".alert-danger").remove();
            $(".required:visible, .mandatory:visible").each(function () {
                if ($(this).val() == "" || $(this).val() == null || ($(this).attr('type') == "checkbox" && !$(this).is(":checked"))) {
                    $(this).closest("div").append('<div class="alert-danger ps-1">This field is required</div>');
                    $(this).addClass('danger')
                    valid = false;
                }
            });
            $(".email:visible").each(function () {
                var emailReg = /^([\w-\.]+@([\w-]+\.)+[\w-]{2,4})?$/
                email_check = emailReg.test($(this).val())
                if (email_check == false) {
                    $(this).closest("div").append('<div class="alert-danger ps-1">Invalid email format</div>');
                    $(this).addClass('danger')
                    valid = false;
                }
            })

            if (!valid) {
                $("html, body").animate(
                    {
                        scrollTop: $(".alert-danger:first").offset().top - 80,
                    },
                    100
                );
            }
            return valid;
        }

        $(document).on('input', '.number', function (e) {
            this.value = this.value.replace(/[^0.00-9.99]/g, '').replace(/(\..*)\./g, '$1').replace(new RegExp("(^[\\d]{50})[\\d]", "g"), '$1');
        });

        $(document).on('click', '#save-btn', function(e){
            e.preventDefault();
            if(!validate()){
                return;
            }
            else{
                $('.loader-overlay').addClass('show');
                var form = $("#formValues");
                $('#save-btn').attr('disabled', 'disabled');
                $('#save-btn').text('Please wait...');
                var url_gsheet = $('#formValues').attr("action");
                $.ajax({
                    type: "POST",
                    url: url_gsheet,
                    data: $(form).serialize(),
                    success: function (response) {
                        if (response.result == "success") {
                            Swal.fire({
                                title: "Good Job!",
                                text: "Thank you for submitting",
                                icon: "success",
                            })
                                // $('#save-btn').removeAttr('disabled');
                                // $('#save-btn').text('Submit Again');
                                // $('.loader-overlay').removeClass('show');
                                .then(function () {
                                    window.location = window.location.href;
                                });
                            setTimeout(function () {
                                window.location = window.location.href;
                            }, 3000);
                        } else {
                            Swal.fire({
                                title: "Error!",
                                text: response.error,
                                icon: "error",
                            }).then(function () {
                                $('#save-btn').removeAttr('disabled');
                                $('#save-btn').text('Submit Again');
                                $('.loader-overlay').removeClass('show');
                            });
                        }
                    },
                    error: function (response) {
                        Swal.fire({
                            title: "Error!",
                            text: "Something went wrong",
                            icon: "error",
                        }).then(function () {
                            $('#save-btn').removeAttr('disabled');
                            $('#save-btn').text('Submit Again');
                            $('.loader-overlay').removeClass('show');
                        });
                    }
                });
            }
        })
    </script>
</body>
</html>
